<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Dashboard - Připojení k ESP32</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>🌡️ IoT Dashboard</h2>
                <div class="connection-status">
                    <span class="status-dot" id="status-dot"></span>
                    <span id="connection-status">Odpojeno</span>
                </div>
            </div>
            <ul class="sidebar-nav">
                <li><a href="{{ url_for('connect_page') }}" class="nav-link active">🔌 Připojení</a></li>
                <li><a href="{{ url_for('index') }}" class="nav-link">📈 Přehled</a></li>
                <li><a href="{{ url_for('sensors_page') }}" class="nav-link">🔌 Senzory</a></li>
                <li><a href="{{ url_for('live_data') }}" class="nav-link">📊 Živá data</a></li>
                <li><a href="{{ url_for('devices_page') }}" class="nav-link">💡 Zařízení</a></li>
            </ul>
        </nav>

        <!-- Hlavní obsah -->
        <main class="main-content">
            <header class="content-header">
                <h1>🔌 Připojení k ESP32</h1>
            </header>

            <!-- Stav připojení -->
            <section class="connection-status-card">
                <h2>Stav připojení</h2>
                <div class="status-info">
                    <div class="status-item">
                        <span class="status-label">Typ:</span>
                        <span id="current-type" class="status-value">Žádné</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Stav:</span>
                        <span id="current-status" class="status-value offline">Odpojeno</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Poslední data:</span>
                        <span id="last-data" class="status-value">Žádná</span>
                    </div>
                </div>
            </section>

            <!-- Připojení k reálnému ESP32 -->
            <section class="connection-section">
                <h2>📡 Připojit k reálnému ESP32</h2>
                <form id="real-esp32-form" class="connection-form">
                    <div class="form-group">
                        <label for="esp32-ip">IP adresa ESP32:</label>
                        <input type="text" id="esp32-ip" value="192.168.1.100" placeholder="např. 192.168.1.100">
                    </div>
                    <div class="form-group">
                        <label for="esp32-port">Port:</label>
                        <input type="number" id="esp32-port" value="5000" placeholder="5000">
                    </div>
                    <button type="submit" class="btn btn-primary">🔗 Připojit k ESP32</button>
                </form>
            </section>

            <!-- Virtuální ESP32 -->
            <section class="connection-section">
                <h2>🖥️ Spustit virtuální ESP32</h2>
                <p class="description">Virtuální ESP32 generuje náhodná testovací data pro vývoj a testování.</p>
                <button id="virtual-esp32-btn" class="btn btn-secondary">🎮 Spustit virtuální ESP32</button>
            </section>

            <!-- Odpojení -->
            <section class="connection-section">
                <h2>❌ Odpojit</h2>
                <button id="disconnect-btn" class="btn btn-danger" disabled>🔌 Odpojit od ESP32</button>
            </section>

            <!-- Náhled dat -->
            <section class="data-preview">
                <h2>📊 Náhled přijímaných dat</h2>
                <div class="data-container">
                    <pre id="data-preview">Čekám na data...</pre>
                </div>
            </section>
        </main>
    </div>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script src="{{ url_for('static', filename='js/websocket.js') }}"></script>
    
    <script>
        // Specifický kód pro stránku připojení
        document.addEventListener('DOMContentLoaded', function() {
            // Formulář pro reálné ESP32
            document.getElementById('real-esp32-form').addEventListener('submit', function(e) {
                e.preventDefault();
                connectToRealESP32();
            });

            // Tlačítko pro virtuální ESP32
            document.getElementById('virtual-esp32-btn').addEventListener('click', connectToVirtualESP32);
            
            // Tlačítko pro odpojení
            document.getElementById('disconnect-btn').addEventListener('click', disconnectESP32);

            // Načtení stavu při startu
            checkConnectionStatus();
        });

        async function connectToRealESP32() {
            const ip = document.getElementById('esp32-ip').value;
            const port = document.getElementById('esp32-port').value;

            try {
                const response = await fetch('/api/connect/real', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip, port })
                });

                const result = await response.json();
                showMessage(result.message, result.status);
                
            } catch (error) {
                showMessage('Chyba připojení: ' + error, 'error');
            }
        }

        async function connectToVirtualESP32() {
            try {
                const response = await fetch('/api/connect/virtual', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                showMessage(result.message, result.status);
                
            } catch (error) {
                showMessage('Chyba: ' + error, 'error');
            }
        }

        async function disconnectESP32() {
            try {
                const response = await fetch('/api/disconnect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                showMessage(result.message, result.status);
                
            } catch (error) {
                showMessage('Chyba odpojení: ' + error, 'error');
            }
        }

        function showMessage(message, type) {
            // Jednoduché zobrazení zprávy
            alert(`[${type.toUpperCase()}] ${message}`);
        }

        function checkConnectionStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    updateConnectionStatus(data);
                });
        }

        function updateConnectionStatus(status) {
            const typeElem = document.getElementById('current-type');
            const statusElem = document.getElementById('current-status');
            const disconnectBtn = document.getElementById('disconnect-btn');

            typeElem.textContent = status.type || 'Žádné';
            statusElem.textContent = status.connected ? 'Připojeno' : 'Odpojeno';
            statusElem.className = status.connected ? 'status-value online' : 'status-value offline';
            disconnectBtn.disabled = !status.connected;
        }
    </script>
</body>
</html>